<!DOCTYPE HTML>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="css/gradient_tool.css">

  <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>

  <script language="JavaScript" src="js/gradient_data.js"></script>

    <script>
      //setup tabbar controller
      $(function() {
        $( "#tabs" ).tabs();
      });

    var STOREDIMAGE = new Image(); // Store the image data apart from the canvas

    window.onload = function() {

        //imageFromURL("../sample/deposition/paper_fig1d_magnified.png");  // TODO for debugging only
        //imageFromURL("img/nanoparticle_tem_chembark.jpg");  // TODO for debugging only

        var k;
        for (k in lowCycle){
            addGradient(k, lowCycle[k]);
        }
        for (k in midCycle){
            addGradient(k, midCycle[k]);
        }
        for (k in highCycle){
            addGradient(k, highCycle[k]);
        }

    };

    function imgToCanvas(imgData){
        // When an image is loaded, update the canvas drawing

        console.log("Event firing");

        var canvas = document.getElementById('display_image');
        var ctx = canvas.getContext('2d');

        canvas.width = imgData.width;
        canvas.height = imgData.height;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.drawImage(imgData, 0, 0);

        greyScaleImg(canvas);

        // Once image is loaded, enable the save link
        document.getElementById("save_button").removeAttribute("disabled");
        document.getElementById("gradients").style.display = "";
    }

    function imageFromURL(url){
        //var imgData = new Image();
        STOREDIMAGE = null;
        STOREDIMAGE = new Image();
        STOREDIMAGE.crossOrigin = 'anonymous'; //'use-credentials';

        STOREDIMAGE.onload = function(){imgToCanvas(STOREDIMAGE)};

        STOREDIMAGE.src = url;
    }

    function imageFromFileBlob(blob){
        if (!blob.type.match("image.*")) {
            console.log('Specified file blob is not an image')
        } else {
            var reader = new FileReader();
            /// Load file data to the image object that FabricJS requires
            reader.onload = function(event){
                STOREDIMAGE = null;
                STOREDIMAGE = new Image();
                STOREDIMAGE.crossOrigin = 'anonymous'; //'use-credentials';
                STOREDIMAGE.onload = function(){imgToCanvas(STOREDIMAGE)};

                STOREDIMAGE.src = event.target.result;
            };
            reader.readAsDataURL(blob);
        }
    }

    function renderFile(event){
        var img_blob = event.target.files[0];
        imageFromFileBlob(img_blob);
    }

    function addGradient(grad_name, color_stops){
     // Add a new rectangular canvas with fill representing specified gradient
     var gradientBox = document.getElementById("gradients");

     var grdCanvas = document.createElement("canvas");
     grdCanvas.width = 256;
     grdCanvas.height = 20;

     var ctx = grdCanvas.getContext('2d');
     var grd = ctx.createLinearGradient(0, 0, grdCanvas.width, 0);

     for (var i=0; i < color_stops.length; i++){
         grd.addColorStop(color_stops[i][0], color_stops[i][1]);
     }
     ctx.fillStyle = grd;
     ctx.fillRect(0, 0, grdCanvas.width, grdCanvas.height);

     var container = document.createElement('div');
     var label = document.createTextNode(grad_name);
     container.appendChild(label);
     container.appendChild(grdCanvas);
     container.className = "gradient";
     gradientBox.appendChild(container);

     // Add event listener only after gradient filled in
     grdCanvas.onclick = function(){ recolorImg(grdCanvas); //recolorImg(grdCanvas)
     };
    }

    function greyScaleImg(canvas){
        // Given a canvas rendering of an image, convert to greyscale
        var ctx = canvas.getContext("2d");

        var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        var data = imageData.data;

        for(var i = 0; i < data.length; i += 4) {
            var brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
            //YUV -> PAL/NTSC
            //var brightness = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            data[i] = brightness; // red
            data[i + 1] = brightness; // green
            data[i + 2] = brightness; // blue
        }
        ctx.putImageData(imageData,0,0);
    }

    function saveCanvas(linkEl){
        // Save the modified/ recolored image data to a file
        var canvas = document.getElementById("display_image");
        linkEl.href = canvas.toDataURL('image/png');
    }

    function recolorImg(grdCanvas){
     // Apply the given gradient data to an image
     imgToCanvas(STOREDIMAGE); // Always recolor from original image to avoid loss of color when two gradients applied in sequence

     var imgCvs = document.getElementById("display_image");
     var imgCtx = imgCvs.getContext('2d');
     var imgData = imgCtx.getImageData(0, 0, imgCvs.width, imgCvs.height);


     var imgOrig = imgData.data;
     var imgRecolor = imgData.data;

     var grdCtx = grdCanvas.getContext('2d');
     var grdData = grdCtx.getImageData(0, 0, grdCanvas.width, grdCanvas.height);
     var grdArr = grdData.data;

     // TODO: for every pixel in array,
     // colorization method from: http://podeplace.blogspot.com/2012/12/pseudocolorisation-with-javascript.html
     for(var y = 0; y < imgCvs.height; y++) {
         for (var x = 0; x < imgCvs.width; x++) {
             var index = (x + y * imgCvs.width) * 4;

             //we grab the color from one channel (the red one)
             var luminosityValue = imgOrig[index + 0];

             //we retrieve the corresponding (R,G,B) triplet from the colormap
             //we rewrite the new color
             imgRecolor[index + 0] = grdArr[luminosityValue * 4 + 0]; //R
             imgRecolor[index + 1] = grdArr[luminosityValue * 4 + 1]; //G
             imgRecolor[index + 2] = grdArr[luminosityValue * 4 + 2]; //B
             //dataRes[index+3] = 255; //no need to change alpha value
         }}
     imgData.data = imgRecolor;
     imgCtx.putImageData(imgData, 0, 0);
    }
  </script>
</head>
<body class="container">
<h2>Suspect image recoloring tool</h2>

  <div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-10 center-block">
        <div>
            <canvas id="display_image" width="500" height="200" class="center-block"></canvas>
        </div>
    </div>
    <div class="col-md-1"></div>
  </div>
  <div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-6">
        <div id="tabs">
            <!--  TODO: reconcile bootstrap and jqueryui tab widgets; make styling and active selector look good (and centered!)-->
            <ul class="nav nav-tabs">
                <li><a href="#tabs-1">Select file</a></li>
                <li><a href="#tabs-2">Enter URL</a></li>
            </ul>

            <div id="tabs-1">
                <label for="pick_image">Select an image file from your local computer:</label> <input type="file" id="pick_image" onchange="renderFile(event)"/>
            </div>
            <div id="tabs-2">
                <label for="pick_url">Enter the URL of an image on the web:</label> <input id="pick_url" type="text" onchange="imageFromURL(this.value)"/>
            </div>
        </div>
    </div>
    <div class="col-md-4">
      <a href="#" id="save_button" onclick="saveCanvas(this)" download="recolor.png" class="btn btn-primary btn-lg" disabled>Save image data</a>
    </div>
    <div class="col-md-1"></div>
  </div>

  <div class="row">
      <div class="col-md-2"></div>

      <div id="gradients" class="col-md-8" style="display:none;"></div>

      <div class="col-md-2"></div>
  </div>
</body>
</html>
