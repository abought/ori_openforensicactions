<!DOCTYPE HTML>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <style>
   body {
     margin: 0px;
      padding: 0px;
   }
   #display_image {
     border: 1px solid #9C9898;
   }
  </style>
  <script language="JavaScript" src="js/fabric.js"></script>
 <script>
    window.onload = function() {
        image_from_url("../sample/deposition/paper_fig1d_magnified.png");
        add_gradient();  // TODO: Implement auto-addition of gradients w/colorstops
    };

    function image_from_url(url){
      var canvas = new fabric.Canvas('display_image');

      fabric.Image.fromURL(url, function(img) {
          canvas.setWidth(img.width);
          canvas.setHeight(img.height);

          img.filters.push(new fabric.Image.filters.Grayscale());

          // apply filters and re-render canvas when done

          img.setGradient('fill', {
                  type: 'linear',
                  x1: -img.width / 2,
                  y1: 0,
                  x2: img.width / 2,
                  y2: 0,
                  colorStops: {
                      0: 'red',
                      0.5: '#005555',
                      1: 'rgba(0,0,255,0.5)'
              }

          });

          img.applyFilters(canvas.renderAll.bind(canvas));


          canvas.clear().renderAll();
          canvas.add(img);

      });

      // TODO: enable zooming
    }

    function image_from_fileblob(blob){
        if (!blob.type.match("image.*")) {
            console.log('Specified file blob is not an image')
        } else {

            var canvas = new fabric.Canvas('display_image');

            var reader = new FileReader();
            /// Load file data to the image object that FabricJS requires
            reader.onload = function(event){
                var imgData = new Image();
                imgData.src = event.target.result;
                imgData.onload = function(){
                    var image = new fabric.Image(
                            imgData,
                            {},
                            'anonymous');
                    console.log("wh", imgData.width, imgData.height);
                    canvas.setWidth(imgData.width);
                    canvas.setHeight(imgData.height);
                    canvas.clear().renderAll();
                    canvas.add(image);
                };

            };
            reader.readAsDataURL(blob);
        }
    }

    function render_file(event){
        var img_blob = event.target.files[0];
        console.log(event, img_blob);
        image_from_fileblob(img_blob);
    }


     function add_gradient(grad_name, color_stops){
         // Add a new rectangular canvas with fill representing specified gradient
         // TODO: Change to any grad box
         var grad_box = document.getElementById("low_cycle_gradients");


          //TODO fix
          var newCanvas = document.createElement("canvas");

         grad_box.appendChild(newCanvas);

         var gradCanvas = new fabric.Canvas(newCanvas,
                 {width: 500, height:20});

         var rect = new fabric.Rect({
             fill: 'red',
             width: gradCanvas.width,
             height: gradCanvas.height
         });
         console.log(rect.width, rect.height);
         gradCanvas.add(rect);
         gradCanvas.renderAll();

         // TODO Implement putimagedata() to change data on canvas later
         // TODO: implement display of chosen gradients
     }
</script>
</head>
<body>
  <div>
      <canvas id="display_image"></canvas>
  </div>

  <p>Select an image to preview: <input type="file" id="pick_image" onchange="render_file(event)"></p>

  <div id="low_cycle_gradients"></div>
  <div id="mid_cycle_gradients"></div>
  <div id="high_cycle_gradients"></div>

</body>
</html>
